---
title: "01-import"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
    email: jinlong.ru@gmail.com
date: 2022-11-06
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: article
reference-location: margin
citation-location: margin
params:
  name: "01-import"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r setup}
#| message: false
#| include: false
here::i_am(paste0(params$name, ".qmd"), uuid = "68d84c08-062a-4f62-90d7-09076c16fd58")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
dir.create(path_raw, recursive = T)
path_data <- here::here(path_raw, params$name)
dir.create(path_data, recursive = T)
```

```{r packages}
#| message: false
#| warning: false
library(here)
library(conflicted)
library(tidyverse)
library(openxlsx)
library(data.table)
library(plotly)
devtools::load_all()
```

## Tasks

The first task is to import output of nextflow pipeline, and save them as `*.rds` file for downstream analyses. Only UCSC samples were used.

```{r import pipeline results}
fin_meta <- here(path_source("00-raw"), "metadata-ucsc.xlsx")
species_ucsc <- c("african_clawed_frog", "chicken", "cow", "fly", "human", "macaque", "mouse", "nematode", "pig", "rabbit", "rat", "tropical_clawed_frog", "zebrafish")

nfrst <- purrr::map(species_ucsc, import_nf, fin_meta = fin_meta, nfpath = here(path_data, "nfrst"))
purrr::map2(species_ucsc, nfrst, ~ saveRDS(.y, file = path_target(paste0("rst_", .x, ".rds")), compress = "gzip"))
```


```{r example}
nfsave <- readRDS(path_target("rst_cow.rds"))
symbol2ensembl <- read.delim(here(path_data, "symbol2ensembl.txt"))
rst <- create_tbl_apa(nfsave, symbol2ensembl)
df_pdui_anno <- rst$pdui_anno

df_pdui_abundance <- pivot_longer2(rst$pdui_value, values_to = "pdui") %>% 
  dplyr::filter(!is.na(pdui)) %>% 
  dplyr::inner_join(pivot_longer2(nfsave$salmon$abundance, values_to = "TPM"),
                    by = c("sample_id", "transcript_id")) %>% 
  dplyr::mutate(logTPM = log(TPM+1))

df_pdui_abundance_meta <- df_pdui_abundance %>% 
  dplyr::left_join(nfsave$metadata[, c("sample_id", "tissue", "sex", "dev_stage")], by = "sample_id")

fwrite(df_pdui_abundance_meta, file = path_target("pdui_abundance.csv"))
fwrite(df_pdui_anno, file = path_target("pdui_anno.csv"))
fwrite(nfsave$metadata, file = path_target("pdui_metadata.csv"))
```



## Files written

These files have been written to the target directory, ```r paste0("data/", params$name)```:

```{r list-files-target}
projthis::proj_dir_info(path_target())
```
