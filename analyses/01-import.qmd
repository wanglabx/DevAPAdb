---
title: "01-import"
title-block-banner: true
author:
  - name: Jinlong Ru
    orcid: 0000-0002-6757-6018
    email: jinlong.ru@gmail.com
date: 2022-11-06
toc: true
toc-depth: 4
number-sections: true
code-fold: true
code-line-numbers: true
code-tools: true
format: 
  html:
    embed-resources: true
    smooth-scroll: true
    page-layout: article
reference-location: margin
citation-location: margin
params:
  name: "01-import"
---

**Updated: `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'CET')` CET.**

The purpose of this document is ...

```{r setup}
#| message: false
#| include: false
here::i_am(paste0(params$name, ".qmd"), uuid = "68d84c08-062a-4f62-90d7-09076c16fd58")
projthis::proj_create_dir_target(params$name, clean = FALSE)
path_target <- projthis::proj_path_target(params$name)
path_source <- projthis::proj_path_source(params$name)
path_raw <- path_source("00-raw")
dir.create(path_raw, recursive = T)
path_data <- here::here(path_raw, params$name)
dir.create(path_data, recursive = T)
```

```{r packages}
#| message: false
#| warning: false
library(here)
library(conflicted)
library(tidyverse)
library(openxlsx)
library(data.table)
devtools::load_all()
```

## Tasks

The first task is to import output of nextflow pipeline, and save them as `*.rds` file for downstream analyses. Only UCSC samples were used.

```{r import pipeline results}
fin_meta <- here(path_source("00-raw"), "metadata-ucsc.xlsx")
species_ucsc <- c("african_clawed_frog", "chicken", "cow", "fly", "human", "macaque", "mouse", "nematode", "pig", "rabbit", "rat", "tropical_clawed_frog", "zebrafish")

nfrst <- purrr::map(species_ucsc, import_nf, fin_meta = fin_meta, nfpath = here(path_data, "nfrst"))
purrr::map2(species_ucsc, nfrst, ~ saveRDS(.y, file = path_target(paste0("rst_", .x, ".rds")), compress = "gzip"))
```


```{r import results example}
rst_example <- readRDS(path_target("rst_cow.rds"))

# The RDS file including:
# 1. metadata: sample metadata
# 2. salmon: salmon quant results
# 3. pdui: dapars2 PDUI results
str(rst_example)
```


```{r}
row_data <- rst_example
symbol2ensembl <- read.delim(here(path_data, "symbol2ensembl.txt"))

a1 <- create_tbl_apa(row_data, symbol2ensembl)

information_sample <- row_data[["metadata"]][, c(9, 4, 3, 5, 7)] %>%
    add_count(name = "tissue_sampleS", tissue)

information_sample <- information_sample %>%
    group_by(tissue) %>%
    add_count(name = "dev_stage_sampleS", dev_stage) %>%
    distinct(tissue, dev_stage, .keep_all = T)

View(row_data$metadata)
```




## Files written

These files have been written to the target directory, ```r paste0("data/", params$name)```:

```{r list-files-target}
projthis::proj_dir_info(path_target())
```
